import os

import numpy as np
import pandas as pd

from base import Session, evaluate


def item_statistics(clicks_and_buys):
    
    def n_unique_sessions(session_ids):
        return len(np.unique(session_ids))

    buys_clicks_by_items = pd.DataFrame.from_dict({
        'N_CLICKS': clicks_and_buys[clicks_and_buys.N_CLICKS > 0].groupby('ITEM_ID').size(),
        'N_SESSIONS': clicks_and_buys[clicks_and_buys.N_CLICKS > 0].groupby('ITEM_ID')['SESSION_ID'].agg(n_unique_sessions),
        'N_BUYS': clicks_and_buys[clicks_and_buys.N_BUYS > 0].groupby('ITEM_ID').size()
    }).fillna(0)

    buys_clicks_by_items.index.name = 'ITEM_ID'
    buys_clicks_by_items['BUYS/SESSIONS'] = buys_clicks_by_items['N_BUYS'] / buys_clicks_by_items['N_SESSIONS']
    buys_clicks_by_items = buys_clicks_by_items.sort('N_BUYS', ascending=False)
    
    return buys_clicks_by_items


if __name__ == '__main__':
    data_directory = '/home/guillaume/Documents/recsys_challenge/yoochoose-data'
    clicks_and_buys = pd.read_pickle(os.path.join(data_directory, 'clicks_and_buys.df'))
    test_clicks = pd.read_pickle(os.path.join(data_directory, 'test_clicks.df'))

    item_stats = item_statistics(clicks_and_buys)

    # debug
    print item_stats.sort('N_BUYS', ascending=False).head(10)
    import matplotlib.pyplot as plt
    plt.hist(item_stats.ix[item_stats['N_BUYS'] > 0, 'BUYS/SESSIONS'], bins=50)
    plt.savefig('most_likely_bought_when_seen_item.png')
    plt.close()

    # VALIDATION
    validation_clicks_and_buys = clicks_and_buys.iloc[:1000000,:]
    validation_sessions = Session.group_validation_sessions(
        validation_clicks_and_buys[['SESSION_ID', 'ITEM_ID', 'N_BUYS']].values)
    predicted_validation_clicks = validation_clicks_and_buys.merge(
        on='ITEM_ID',
        right=item_stats['BUYS/SESSIONS'].reset_index()
    ).sort('SESSION_ID')
    rate_threshold = .1
    predicted_validation_clicks = predicted_validation_clicks[predicted_validation_clicks['BUYS/SESSIONS'] > rate_threshold]
    predicted_validation_sessions = Session.group_sessions(
        predicted_validation_clicks[['SESSION_ID', 'ITEM_ID']].values)
    print evaluate(predicted_validation_sessions, validation_sessions)

    # prediction by JOINING test_clicks with item_stats['BUYS/SESSIONS']
    predicted_test_clicks = test_clicks.merge(
        on='ITEM_ID',
        right=item_stats['BUYS/SESSIONS'].reset_index()
    ).sort('SESSION_ID')

    # Gives a buy/click ratio of .0525 and ~11,000 on http://2015.recsyschallenge.com/submission.html 
    rate_threshold = .1
    predicted_test_clicks = predicted_test_clicks[predicted_test_clicks['BUYS/SESSIONS'] > rate_threshold]
    print predicted_test_clicks.shape[0] / float(test_clicks.shape[0])

    import base
    predicted_sessions = base.Session.group_sessions(
        session_and_item_ids=predicted_test_clicks[['SESSION_ID', 'ITEM_ID']].values)
    
    with open('./solutions/most_likely_bought_when_seen_solution.dat', 'w') as fp:
        fp.writelines(session.to_csv_line() for session in predicted_sessions)
